## Milestone: Members — API

> **Validates:**
> - `POST /auth/login` with `{"email":"mgarner22@gmail.com"}` returns HTTP 200 with a session cookie
> - `GET /api/members` with session cookie returns HTTP 200 with a JSON array (should include the seeded member)
> - `GET /api/members?search=mgarner` returns HTTP 200 with a filtered JSON array
> - `POST /api/members` with `{"firstName":"Jane","lastName":"Doe","email":"jane@example.com","role":"Member"}` returns HTTP 201 with an `id` field
> - `GET /api/members/{id}` returns HTTP 200 with matching `firstName`, `lastName`, `email`, `role`, `isActive: true`
> - `PUT /api/members/{id}` with `{"firstName":"Jane","lastName":"Smith","email":"jane@example.com","role":"Member","isActive":true}` returns HTTP 200 with updated `lastName`
> - `GET /api/members/{id}/assignments` returns HTTP 200 with a JSON array (may be empty)
> - `POST /api/members/{id}/deactivate` returns HTTP 200 with `isActive: false`
> - `GET /api/members` without a session cookie returns HTTP 401

> **Reference files:**
> - `src/Stretto.Domain/Entities/Member.cs` — entity already defined (Id, FirstName, LastName, Email, Role, IsActive, OrganizationId)
> - `src/Stretto.Application/DTOs/VenueDtos.cs` — pattern for record DTOs with validation attributes
> - `src/Stretto.Application/Interfaces/IVenueService.cs` — pattern for service interface
> - `src/Stretto.Application/Services/VenueService.cs` — pattern for service: constructor-inject `IRepository<T>`, throw typed exceptions, return DTOs
> - `src/Stretto.Api/Controllers/VenuesController.cs` — thin controller pattern; `GetSessionAsync()` helper; admin-only role check
> - `src/Stretto.Api/Program.cs` — add `AddScoped<IMemberService, MemberService>()` here

- [x] Fix `AuthController.Login` in `src/Stretto.Api/Controllers/AuthController.cs`: remove `MaxAge = TimeSpan.FromDays(30)` from the `CookieOptions` so that only `Expires = DateTimeOffset.UtcNow.AddHours(8)` controls expiry — `MaxAge` takes precedence over `Expires` in all modern browsers and was overriding the 8-hour limit (fixes findings #101 and #88)

- [ ] Fix `ProgramYearService.MarkCurrentAsync` in `src/Stretto.Application/Services/ProgramYearService.cs`: load all program years for the org via `_programYears.ListAsync(orgId)` first, then iterate the list setting `IsCurrent = false` on every entry where `py.Id != id` (calling `UpdateAsync` for each changed entry), then load the target year via `GetByIdAsync(id, orgId)` (throw `NotFoundException` if null), set `IsCurrent = true`, call `UpdateAsync`, return `ToDto` — this prevents a partial failure leaving multiple years marked current (fixes finding #99)

- [ ] Fix `VenueFormPage` in `src/Stretto.Web/src/pages/VenueFormPage.tsx`: in `saveMutation.mutationFn`, after the `fetch(...)` call, add `if (!response.ok) { const err = await response.json().catch(() => ({ message: 'Request failed' })); throw new Error(err.message ?? 'Request failed'); }` before returning; in the JSX, render `{saveMutation.isError && <p data-testid="form-error" className="text-destructive text-sm">{(saveMutation.error as Error).message}</p>}` above the submit button (fixes finding #94)

- [ ] Create `src/Stretto.Application/DTOs/MemberDtos.cs` with records: `MemberDto(Guid Id, string FirstName, string LastName, string Email, string Role, bool IsActive)`; `MemberAssignmentSummaryDto(Guid ProjectId, string ProjectName)`; `CreateMemberRequest([Required][MaxLength(100)] string FirstName, [Required][MaxLength(100)] string LastName, [Required][EmailAddress][MaxLength(200)] string Email, [Required] string Role)`; `UpdateMemberRequest([Required][MaxLength(100)] string FirstName, [Required][MaxLength(100)] string LastName, [Required][EmailAddress][MaxLength(200)] string Email, [Required] string Role, bool IsActive)`

- [ ] Create `src/Stretto.Application/Interfaces/IMemberService.cs` with methods: `Task<List<MemberDto>> ListAsync(Guid orgId, string? search)`; `Task<MemberDto> GetAsync(Guid id, Guid orgId)`; `Task<List<MemberAssignmentSummaryDto>> GetAssignmentsAsync(Guid id, Guid orgId)`; `Task<MemberDto> CreateAsync(Guid orgId, CreateMemberRequest req)`; `Task<MemberDto> UpdateAsync(Guid id, Guid orgId, UpdateMemberRequest req)`; `Task<MemberDto> DeactivateAsync(Guid id, Guid orgId)`

- [ ] Create `src/Stretto.Application/Services/MemberService.cs` implementing `IMemberService`; constructor-inject `IRepository<Member> _members`, `IRepository<ProjectAssignment> _assignments`, `IRepository<Project> _projects`; `ListAsync(orgId, search)` calls `_members.ListAsync(orgId)`, filters in-memory by search when non-null (check `Contains(search, StringComparison.OrdinalIgnoreCase)` against FirstName, LastName, Email), then orders by `m.LastName, m.FirstName`; `GetAsync(id, orgId)` calls `GetByIdAsync`, throws `NotFoundException("Member not found")` if null, returns `ToDto`; `GetAssignmentsAsync(id, orgId)` calls `_assignments.ListAsync(orgId, a => a.MemberId == id)`, then for each assignment calls `_projects.GetByIdAsync(a.ProjectId, orgId)` and maps to `MemberAssignmentSummaryDto` (skip entries where project is null); `CreateAsync(orgId, req)` validates the Role string via `Enum.TryParse<Role>(req.Role, out var role)` throwing `ValidationException(new Dictionary<string,string>{ ["role"] = "Invalid role" })` on failure, checks for duplicate email via `_members.FindOneAsync(m => m.OrganizationId == orgId && m.Email == req.Email)` throwing `ValidationException(new Dictionary<string,string>{ ["email"] = "Email already in use" })` if found, creates and adds `new Member { Id = Guid.NewGuid(), FirstName = req.FirstName, LastName = req.LastName, Email = req.Email, Role = role, IsActive = true, OrganizationId = orgId }`, returns `ToDto`; `UpdateAsync(id, orgId, req)` loads member (throws `NotFoundException` if null), parses Role (throws `ValidationException` on failure), updates all fields, calls `UpdateAsync`, returns `ToDto`; `DeactivateAsync(id, orgId)` loads member (throws `NotFoundException` if null), sets `IsActive = false`, calls `UpdateAsync`, returns `ToDto`; private static `ToDto(Member m)` returns `new MemberDto(m.Id, m.FirstName, m.LastName, m.Email, m.Role.ToString(), m.IsActive)`; add `using Stretto.Domain.Enums;` and `using Stretto.Domain.Entities;`

- [ ] Register `IMemberService` in `src/Stretto.Api/Program.cs`: add `builder.Services.AddScoped<IMemberService, MemberService>();` after the existing `builder.Services.AddScoped<IVenueService, VenueService>();` line; add `using Stretto.Application.Services;` if not already present

- [ ] Create `src/Stretto.Api/Controllers/MembersController.cs` with `[ApiController]`, `[Route("api/members")]`; constructor-inject `IMemberService _memberService` and `IAuthService _authService`; private async helper `GetSessionAsync()` reads `Request.Cookies["stretto_session"]`, throws `UnauthorizedException()` if null, calls `_authService.ValidateAsync(token)`, throws `UnauthorizedException()` if null, returns `(dto.OrgId, dto.Role)`; actions: `[HttpGet]` with `[FromQuery] string? search` → `Ok(await _memberService.ListAsync(orgId, search))`; `[HttpGet("{id:guid}")]` → `Ok(await _memberService.GetAsync(id, orgId))`; `[HttpGet("{id:guid}/assignments")]` → `Ok(await _memberService.GetAssignmentsAsync(id, orgId))`; `[HttpPost]` → check role == "Admin" (throw `ForbiddenException("Only admins can create members")` otherwise), `Created($"/api/members/{dto.Id}", dto)` where `dto = await _memberService.CreateAsync(orgId, req)`; `[HttpPut("{id:guid}")]` → admin only, `Ok(await _memberService.UpdateAsync(id, orgId, req))`; `[HttpPost("{id:guid}/deactivate"]` → admin only, `Ok(await _memberService.DeactivateAsync(id, orgId))`
