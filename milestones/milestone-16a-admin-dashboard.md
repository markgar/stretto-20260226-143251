## Milestone: Admin Dashboard

> **Validates:**
> - `GET /api/dashboard/summary` without a session cookie returns HTTP 401
> - `POST /api/auth/login` with `mgarner22@gmail.com`; then `GET /api/dashboard/summary` returns HTTP 200 with JSON body containing `programYearId`, `programYearName`, `upcomingEvents` (array), and `recentActivity` (array)
> - `GET /api/dashboard/summary` when no current program year exists returns HTTP 200 with `programYearId: null` and empty `upcomingEvents` and `recentActivity` arrays
> - `GET /api/dashboard/summary?programYearId={id}` with a valid program year id returns HTTP 200 with `programYearId` matching the requested id
> - `GET /api/dashboard/summary?programYearId={unknownId}` returns HTTP 404
> - `GET /api/dashboard/summary` authenticated as `mgarner@outlook.com` (Member role) returns HTTP 403
> - Navigate to `/` (Dashboard) as admin: the page renders with `data-testid="dashboard-heading"`, a program year selector (`data-testid="program-year-select"`), an upcoming events section (`data-testid="upcoming-events-section"`), and a recent activity section (`data-testid="recent-activity-section"`)
> - When no upcoming events exist, the upcoming events section renders an element with `data-testid="no-events-message"`

> **Reference files:**
> - `src/Stretto.Domain/Entities/Event.cs` — entity shape; follow this pattern for adding `CreatedAt` to Member and ProjectAssignment
> - `src/Stretto.Infrastructure/Data/Configurations/EventConfiguration.cs` — Fluent API mapping pattern for adding `CreatedAt` property mapping
> - `src/Stretto.Application/Services/EventService.cs` — service pattern: constructor-inject repositories, call `ListAsync` with predicate, map to DTO
> - `src/Stretto.Api/Controllers/EventsController.cs` — thin controller inheriting `ProtectedControllerBase`; role check with `GetSessionAsync`; route and action patterns
> - `src/Stretto.Web/src/pages/DashboardPage.tsx` — file to replace with the full dashboard implementation
> - `src/Stretto.Web/src/pages/useProgramYearsList.ts` — `useQuery` + `useMutation` hook pattern to follow for `useDashboard.ts`
> - `src/Stretto.Api/Program.cs` — add `AddScoped<IDashboardService, DashboardService>()` here
> - `src/Stretto.Infrastructure/Data/AppDbContext.cs` — no changes needed; `Member` and `ProjectAssignment` DbSets already registered

- [ ] Add `public DateTime CreatedAt { get; set; } = DateTime.UtcNow;` to `src/Stretto.Domain/Entities/Member.cs`; add `builder.Property(m => m.CreatedAt).IsRequired();` to `src/Stretto.Infrastructure/Data/Configurations/MemberConfiguration.cs`

- [ ] Add `public DateTime CreatedAt { get; set; } = DateTime.UtcNow;` to `src/Stretto.Domain/Entities/ProjectAssignment.cs`; add `builder.Property(pa => pa.CreatedAt).IsRequired();` to `src/Stretto.Infrastructure/Data/Configurations/ProjectAssignmentConfiguration.cs`

- [ ] Create `src/Stretto.Application/DTOs/DashboardDtos.cs` with three records: `UpcomingEventDto(Guid Id, Guid ProjectId, string ProjectName, EventType EventType, DateOnly Date, TimeOnly StartTime, int DurationMinutes, string? VenueName)`; `RecentActivityItem(string ActivityType, string Description, DateTime OccurredAt)` where `ActivityType` is either `"NewMember"` or `"NewAssignment"`; `DashboardSummaryDto(Guid? ProgramYearId, string? ProgramYearName, List<UpcomingEventDto> UpcomingEvents, List<RecentActivityItem> RecentActivity)`

- [ ] Create `src/Stretto.Application/Interfaces/IDashboardService.cs` with two method signatures: `Task<DashboardSummaryDto> GetCurrentSummaryAsync(Guid orgId)` (uses the IsCurrent program year, returns empty summary if none); `Task<DashboardSummaryDto> GetSummaryAsync(Guid programYearId, Guid orgId)` (throws `NotFoundException("Program year not found")` if not found)

- [ ] Create `src/Stretto.Application/Services/DashboardService.cs` implementing `IDashboardService`; constructor-inject `IRepository<ProgramYear>`, `IRepository<Project>`, `IRepository<Event>`, `IRepository<Venue>`, `IRepository<Member>`, `IRepository<ProjectAssignment>`; `GetCurrentSummaryAsync` finds the current program year via `ListAsync(orgId, y => y.IsCurrent)` — returns `new DashboardSummaryDto(null, null, [], [])` if none found, otherwise calls `BuildSummaryAsync`; `GetSummaryAsync` calls `GetByIdAsync(programYearId, orgId)` (throw `NotFoundException("Program year not found")` if null) then calls `BuildSummaryAsync`; private `BuildSummaryAsync(ProgramYear year, Guid orgId)` fetches all projects in the year via `ListAsync(orgId, p => p.ProgramYearId == year.Id)`, gets all events for those projects filtered to `Date >= DateOnly.FromDateTime(DateTime.UtcNow) && Date <= DateOnly.FromDateTime(DateTime.UtcNow.AddDays(30))`, resolves venue names, maps events to `UpcomingEventDto` sorted ascending by `Date` then `StartTime`; fetches members with `CreatedAt >= DateTime.UtcNow.AddDays(-14)` mapped to `RecentActivityItem("NewMember", $"{m.FirstName} {m.LastName} joined as a member", m.CreatedAt)`; fetches assignments with `CreatedAt >= DateTime.UtcNow.AddDays(-14)` and resolves member/project names, mapped to `RecentActivityItem("NewAssignment", $"{memberName} assigned to {projectName}", a.CreatedAt)`; merges and sorts activity list descending by `OccurredAt` and returns `DashboardSummaryDto`

- [ ] Register `IDashboardService` in `src/Stretto.Api/Program.cs`: add `builder.Services.AddScoped<IDashboardService, DashboardService>();` after the existing service registrations; add `using Stretto.Application.Interfaces;` and `using Stretto.Application.Services;` if not already present

- [ ] Create `src/Stretto.Api/Controllers/DashboardController.cs` with `[ApiController]`, `[Route("api/dashboard")]`, inheriting `ProtectedControllerBase`; constructor-inject `IDashboardService` and `IAuthService`; implement `GET /api/dashboard/summary` as `[HttpGet("summary")]`: call `GetSessionAsync()`, require Admin role (return `Forbid()` if role is not `"Admin"`), check for optional `[FromQuery] Guid? programYearId` — if provided call `GetSummaryAsync(programYearId.Value, orgId)`, otherwise call `GetCurrentSummaryAsync(orgId)`; return `Ok(dto)`

- [ ] Fix `src/Stretto.Infrastructure/LocalFileStorageProvider.cs` (finding #285): sanitize the `fileName` parameter in `SaveAsync` by replacing any path separator characters with underscores before combining with the storage root — use `Path.GetFileName(fileName)` to strip any directory components, then verify the resulting path starts with the configured root directory; throw `ValidationException` if path traversal is detected

- [ ] Fix `src/Stretto.Infrastructure/LocalFileStorageProvider.cs` (finding #272): in `ProjectMaterialsService.AddLinkAsync` validate that `req.Url` starts with `https://` or `http://` (case-insensitive); throw `ValidationException(new Dictionary<string,string[]>{["url"]=["URL must start with http:// or https://"]})` if it does not

- [ ] Regenerate the TypeScript client: delete any stale `src/Stretto.Web/swagger.json` if it exists and is empty, then run `cd src/Stretto.Web && npm run generate` so `DashboardSummaryDto`, `UpcomingEventDto`, `RecentActivityItem`, and the `/api/dashboard/summary` endpoint appear in `src/Stretto.Web/src/api/generated/`

- [ ] Create `src/Stretto.Web/src/pages/useDashboard.ts`: export `useDashboard(programYearId?: string)` hook that uses `useQuery` with key `['dashboard-summary', programYearId ?? 'current']`; fetches `GET /api/dashboard/summary${programYearId ? '?programYearId=' + programYearId : ''}` using `fetch` with `credentials: 'include'`, throws on non-ok response; returns `{ data, isLoading, isError }`

- [ ] Replace `src/Stretto.Web/src/pages/DashboardPage.tsx` with a full implementation: import `useQuery` from `@tanstack/react-query` and `useDashboard` hook; add local `selectedYearId` state initialized to `undefined`; fetch program years with `useQuery(['program-years'], ...)` to populate a `<select data-testid="program-year-select">` dropdown (option value `""` for "Current year", then one option per program year); call `useDashboard(selectedYearId)` to get `{ data, isLoading }`; render `<h1 data-testid="dashboard-heading">Dashboard</h1>`; render upcoming events section in a `<section data-testid="upcoming-events-section">`: while `isLoading` show three `<div className="h-6 animate-pulse rounded bg-muted" />` skeleton rows; when loaded and `data.upcomingEvents.length === 0` render `<p data-testid="no-events-message" className="text-muted-foreground">No upcoming events in the next 30 days.</p>`; otherwise render a table with columns Date, Project, Venue, Type and one `<tr data-testid="event-row">` per event; render recent activity section in a `<section data-testid="recent-activity-section">`: while `isLoading` show three skeleton rows; when loaded and empty render `<p className="text-muted-foreground">No recent activity.</p>`; otherwise render a list with one `<li data-testid="activity-item">` per activity showing description and relative date using `formatDistanceToNow` from `date-fns`
