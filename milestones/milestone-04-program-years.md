## Milestone: Program Years — API + Admin Pages

> **Validates:**
> - `GET /api/program-years` without a session cookie returns HTTP 401
> - `POST /api/auth/login` with `{"email":"mgarner22@gmail.com"}` then `GET /api/program-years` returns HTTP 200 with a JSON array
> - `POST /api/program-years` with `{"name":"2025–2026","startDate":"2025-09-01","endDate":"2026-06-30"}` returns HTTP 201 with an `id` field
> - `GET /api/program-years/{id}` returns HTTP 200 with matching `name`, `isCurrent: false`, `isArchived: false`
> - `PUT /api/program-years/{id}` with updated name returns HTTP 200 with updated `name`
> - `POST /api/program-years/{id}/archive` returns HTTP 200 with `isArchived: true` and `isCurrent: false`
> - `POST /api/program-years/{id}/activate` on a non-archived year returns HTTP 200 with `isCurrent: true`; a second `POST /api/program-years/{other-id}/activate` sets the first year's `isCurrent` to `false`
> - Frontend `/program-years` (authenticated) renders an element with `data-testid="program-years-heading"`
> - Frontend `/program-years/new` renders an input with `data-testid="name-input"` and a button with `data-testid="submit-button"`

> **Reference files:**
> - `src/Stretto.Domain/Entities/ProgramYear.cs` — entity already defined (Id, Name, StartDate, EndDate, IsCurrent, IsArchived, OrganizationId)
> - `src/Stretto.Application/DTOs/AuthDtos.cs` — pattern for record DTOs
> - `src/Stretto.Application/Services/AuthService.cs` — pattern for Application-layer service: constructor-inject `IRepository<T>`, throw typed exceptions, return DTOs
> - `src/Stretto.Api/Controllers/AuthController.cs` — thin controller pattern; cookie reading; `GetOrgIdAsync()` helper pattern used in VenuesController
> - `src/Stretto.Api/Program.cs` — add `AddScoped<ProgramYearService>()` here
> - `src/Stretto.Web/src/pages/LoginPage.tsx` — pattern for React Hook Form + Zod + navigation
> - `src/Stretto.Web/src/App.tsx` — replace `/program-years` placeholder and add nested routes here

- [ ] Fix `AuthController.Login` in `src/Stretto.Api/Controllers/AuthController.cs`: add `Expires = DateTimeOffset.UtcNow.AddHours(8)` to the `CookieOptions` passed to `Response.Cookies.Append` so the session cookie persists across browser restarts (fixes finding #61)

- [ ] Create `src/Stretto.Application/DTOs/ProgramYearDtos.cs` with records: `ProgramYearDto(Guid Id, string Name, DateOnly StartDate, DateOnly EndDate, bool IsCurrent, bool IsArchived)`, `CreateProgramYearRequest(string Name, DateOnly StartDate, DateOnly EndDate)`, `UpdateProgramYearRequest(string Name, DateOnly StartDate, DateOnly EndDate)`

- [ ] Create `src/Stretto.Application/Services/ProgramYearService.cs`; constructor-inject `IRepository<ProgramYear>`; implement `ListAsync(Guid orgId)` calling `_programYears.ListAsync(orgId)` and returning `List<ProgramYearDto>` ordered by StartDate descending; implement `GetAsync(Guid id, Guid orgId)` throwing `NotFoundException("Program year not found")` if null and returning `ProgramYearDto`; implement `CreateAsync(Guid orgId, CreateProgramYearRequest req)` that validates `req.StartDate < req.EndDate` (throw `ValidationException(new Dictionary<string,string>{ ["startDate"] = "Start date must be before end date" })` if not), creates `new ProgramYear { Id = Guid.NewGuid(), Name = req.Name, StartDate = req.StartDate, EndDate = req.EndDate, IsCurrent = false, IsArchived = false, OrganizationId = orgId }`, calls `AddAsync`, returns `ProgramYearDto`

- [ ] Add `UpdateAsync(Guid id, Guid orgId, UpdateProgramYearRequest req)` to `ProgramYearService`: load via `GetAsync` (propagates `NotFoundException`), validate `req.StartDate < req.EndDate` (throw `ValidationException` same as create), update `Name`, `StartDate`, `EndDate` on the entity, call `_programYears.UpdateAsync(entity)`, return `ProgramYearDto`

- [ ] Add `ArchiveAsync(Guid id, Guid orgId)` and `MarkCurrentAsync(Guid id, Guid orgId)` to `ProgramYearService`: `ArchiveAsync` loads entity (throws `NotFoundException` if not found), sets `IsArchived = true` and `IsCurrent = false`, calls `UpdateAsync`, returns `ProgramYearDto`; `MarkCurrentAsync` loads entity (throws `NotFoundException` if not found), throws `ValidationException(new Dictionary<string,string>{ [""] = "Cannot activate an archived program year" })` if `entity.IsArchived`, sets `entity.IsCurrent = true`, calls `UpdateAsync`, then loads all program years via `_programYears.ListAsync(orgId)` and for each where `py.Id != id && py.IsCurrent`, sets `IsCurrent = false` and calls `UpdateAsync`; returns `ProgramYearDto` for the activated year

- [ ] Register `ProgramYearService` in `src/Stretto.Api/Program.cs`: add `builder.Services.AddScoped<ProgramYearService>();` after the existing `AddScoped<AuthService>()` line (add `using Stretto.Application.Services;` if not already present)

- [ ] Create `src/Stretto.Api/Controllers/ProgramYearsController.cs` with `[ApiController]`, `[Route("api/program-years")]`; constructor-inject `ProgramYearService _programYears` and `AuthService _authService`; add private async helper `GetOrgIdAsync()` that reads `Request.Cookies["stretto_session"]`, throws `UnauthorizedException()` if null, calls `_authService.ValidateAsync(token)`, returns `dto.OrgId`; implement six action methods: `[HttpGet] GET /api/program-years` → `Ok(await _programYears.ListAsync(orgId))`; `[HttpPost] POST /api/program-years` → `Created($"/api/program-years/{dto.Id}", dto)`; `[HttpGet("{id}")] GET /api/program-years/{id}` → `Ok(dto)`; `[HttpPut("{id}")] PUT /api/program-years/{id}` → `Ok(dto)`; `[HttpPost("{id}/archive")] POST /api/program-years/{id}/archive` → `Ok(dto)`; `[HttpPost("{id}/activate")] POST /api/program-years/{id}/activate` → `Ok(dto)`

- [ ] Fix `AppShell` in `src/Stretto.Web/src/components/AppShell.tsx`: for each of the three nav sections (desktop `lg+` sidebar, tablet `md–lg` sidebar, mobile bottom bar), append a suffix to every `data-testid` to make them unique across the DOM — change `data-testid={`nav-${item.label...}`}` to `data-testid={`nav-desktop-${item.label...}`}` in the desktop nav, `data-testid={`nav-tablet-${item.label...}`}` in the tablet nav, and `data-testid={`nav-mobile-${item.label...}`}` in the mobile bottom bar (fixes finding #67 — duplicate testids break e2e selectors)

- [ ] Fix auth store in `src/Stretto.Web/src/stores/authStore.ts` to persist the user across page refreshes: change the initial state to read from localStorage — `user: (() => { try { const raw = localStorage.getItem('stretto_user'); return raw ? JSON.parse(raw) as AuthUser : null; } catch { return null; } })()`; in `setUser`, call `localStorage.setItem('stretto_user', JSON.stringify(u))` before `set({ user: u })`; in `clearUser`, call `localStorage.removeItem('stretto_user')` before `set({ user: null })` (fixes finding #66 — page refresh always redirected unauthenticated users to /login)

- [ ] Regenerate the TypeScript API client: start the backend with `dotnet run --project src/Stretto.Api/ -- --urls http://localhost:5000` so Swagger is reachable at `http://localhost:5000/swagger/v1/swagger.json`, then run `npm run generate` from `src/Stretto.Web/`; commit the generated files in `src/Stretto.Web/src/api/generated/`

- [ ] Create `src/Stretto.Web/src/pages/ProgramYearsListPage.tsx`; import `useQuery`, `useMutation`, `useQueryClient` from `@tanstack/react-query`; import `Link` from `react-router-dom`; import `format`, `parseISO` from `date-fns`; import `AppShell` from `../components/AppShell`; `useQuery({ queryKey: ['program-years'], queryFn: () => fetch('/api/program-years', { credentials: 'include' }).then(r => r.json()) })`; render inside `<AppShell>`: `<h1 data-testid="program-years-heading">Program Years</h1>`, a `<Link to="/program-years/new" data-testid="add-program-year-button">New Program Year</Link>` styled as a button, and a list where each row shows Name, start/end dates formatted as `format(parseISO(py.startDate), 'MMM d, yyyy')`, a `<span data-testid={`current-badge-${py.id}`}>Current</span>` badge when `py.isCurrent`, an `<span data-testid={`archived-badge-${py.id}`}>Archived</span>` badge when `py.isArchived`, a `<Link to={`/program-years/${py.id}`} data-testid={`view-${py.id}`}>View</Link>`, an `<button data-testid={`archive-${py.id}`}>Archive</button>` (hidden when `py.isArchived`) wired to `useMutation` posting to `/api/program-years/${py.id}/archive`, and an `<button data-testid={`activate-${py.id}`}>Activate</button>` (hidden when `py.isCurrent || py.isArchived`) wired to `useMutation` posting to `/api/program-years/${py.id}/activate`; both mutations call `queryClient.invalidateQueries({ queryKey: ['program-years'] })` on success

- [ ] Create `src/Stretto.Web/src/pages/ProgramYearCreatePage.tsx`; import `useNavigate` from `react-router-dom`; import `useForm` from `react-hook-form`; import `zodResolver` from `@hookform/resolvers/zod`; import `z` from `zod`; import `useMutation` from `@tanstack/react-query`; import `AppShell`; define schema `z.object({ name: z.string().min(1,'Name is required'), startDate: z.string().min(1,'Start date is required'), endDate: z.string().min(1,'End date is required') })`; derive `FormValues` type with `z.infer`; wire `useForm<FormValues>` with the resolver; `useMutation` that posts `JSON.stringify(values)` to `POST /api/program-years` (`credentials: 'include'`) and navigates to `/program-years` on success; render inside `<AppShell>`: `<h1>New Program Year</h1>` and a form with labeled inputs `<input data-testid="name-input" {...register('name')} />`, `<input type="date" data-testid="start-date-input" {...register('startDate')} />`, `<input type="date" data-testid="end-date-input" {...register('endDate')} />`, and `<button type="submit" data-testid="submit-button" disabled={isSubmitting}>Create Program Year</button>`; display `formState.errors` inline below each field

- [ ] Create `src/Stretto.Web/src/pages/ProgramYearDetailPage.tsx`; import `useParams`, `useNavigate`; import `useQuery`, `useMutation`, `useQueryClient`; import `useForm`, `zodResolver`; import `z`; import `AppShell`; read `id` from `useParams()`; `useQuery({ queryKey: ['program-year', id], queryFn: () => fetch(`/api/program-years/${id}`, { credentials: 'include' }).then(r => r.json()) })`; call `reset(data)` in a `useEffect` when query data loads; use same Zod schema as create page; render inside `<AppShell>`: edit form with `<input data-testid="name-input" />`, `<input type="date" data-testid="start-date-input" />`, `<input type="date" data-testid="end-date-input" />`, and `<button type="submit" data-testid="save-button">Save</button>` wired to `useMutation` PUTting to `/api/program-years/:id`; below the form show `<button data-testid="archive-button">Archive</button>` (when `!data.isArchived`) wired to `useMutation` POSTing to `/api/program-years/${id}/archive` with `onSuccess: () => { queryClient.invalidateQueries(...); navigate('/program-years'); }`; show `<button data-testid="activate-button">Activate</button>` (when `!data.isCurrent && !data.isArchived`) wired to `useMutation` POSTing to `/api/program-years/${id}/activate` with `onSuccess: () => queryClient.invalidateQueries(...)`)

- [ ] Update `src/Stretto.Web/src/App.tsx`: import `ProgramYearsListPage`, `ProgramYearCreatePage`, `ProgramYearDetailPage` from their page files; replace `<Route path="/program-years" element={<ComingSoon />} />` with `<Route path="/program-years" element={<ProgramYearsListPage />} />`; add inside the `<Route element={<ProtectedRoute />}>` block: `<Route path="/program-years/new" element={<ProgramYearCreatePage />} />` and `<Route path="/program-years/:id" element={<ProgramYearDetailPage />} />`
