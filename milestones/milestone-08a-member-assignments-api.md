## Milestone: Member Assignments + Utilization Grid — Backend API

> **Validates:**
> - `POST /api/auth/login` with `mgarner22@gmail.com`; then `GET /api/program-years` to get a program year id; then `GET /api/projects?programYearId=<id>` to get a project id; then `GET /api/members` to get a member id; then `POST /api/projects/<projectId>/members` with body `{"memberId":"<memberId>"}` returns HTTP 201 with JSON containing `id`, `projectId`, `memberId`, `memberFirstName`, `memberLastName`, `memberEmail`
> - `GET /api/projects/<projectId>/members` returns HTTP 200 with a JSON array containing the assignment
> - `POST /api/projects/<projectId>/members` with the same `memberId` a second time returns HTTP 422 (duplicate assignment)
> - `DELETE /api/projects/<projectId>/members/<memberId>` returns HTTP 204; subsequent `GET /api/projects/<projectId>/members` returns an empty array
> - `GET /api/utilization?programYearId=<id>` authenticated as admin returns HTTP 200 with JSON containing `programYearId`, `totalProjects`, `projectIds`, `projectNames`, `rows`; `rows` is an array sorted descending by `assignedCount`
> - `GET /api/utilization?programYearId=<id>` authenticated as member (`mgarner@outlook.com`) returns HTTP 403
> - `GET /api/utilization` without `programYearId` query param returns HTTP 400
> - `POST /api/projects/<projectId>/members` without a session cookie returns HTTP 401

> **Reference files:**
> - `src/Stretto.Domain/Entities/ProjectAssignment.cs` — entity already defined (Id, ProjectId, MemberId, OrganizationId)
> - `src/Stretto.Infrastructure/Repositories/BaseRepository.cs` — `ListAsync(orgId, predicate)` for filtered queries; `DeleteAsync` for removing entities
> - `src/Stretto.Application/Services/ProjectService.cs` — pattern for Application-layer service: constructor-inject `IRepository<T>`, throw typed exceptions, return DTO records, private `ToDto` helper
> - `src/Stretto.Api/Controllers/ProjectsController.cs` — pattern for thin controller: extends `ProtectedControllerBase`, calls `GetSessionAsync()`, checks role, delegates to service
> - `src/Stretto.Api/Program.cs` — register new service with `builder.Services.AddScoped<IProjectAssignmentService, ProjectAssignmentService>()`

- [ ] Create `src/Stretto.Application/DTOs/AssignmentDtos.cs` with five records: `ProjectAssignmentDto(Guid Id, Guid ProjectId, Guid MemberId, string MemberFirstName, string MemberLastName, string MemberEmail)`; `AssignMemberRequest(Guid MemberId)`; `UtilizationRowDto(Guid MemberId, string FirstName, string LastName, int AssignedCount, int TotalProjects, List<Guid> AssignedProjectIds)`; `UtilizationGridDto(Guid ProgramYearId, int TotalProjects, List<Guid> ProjectIds, Dictionary<Guid, string> ProjectNames, List<UtilizationRowDto> Rows)`

- [ ] Create `src/Stretto.Application/Interfaces/IProjectAssignmentService.cs` with four method signatures: `Task<List<ProjectAssignmentDto>> ListByProjectAsync(Guid projectId, Guid orgId)`; `Task<ProjectAssignmentDto> AssignAsync(Guid projectId, Guid orgId, AssignMemberRequest req)`; `Task UnassignAsync(Guid projectId, Guid memberId, Guid orgId)`; `Task<UtilizationGridDto> GetUtilizationGridAsync(Guid programYearId, Guid orgId)`

- [ ] Create `src/Stretto.Application/Services/ProjectAssignmentService.cs` implementing `IProjectAssignmentService`; constructor-inject `IRepository<ProjectAssignment>`, `IRepository<Project>`, and `IRepository<Member>`; `ListByProjectAsync` calls `_assignments.ListAsync(orgId, a => a.ProjectId == projectId)`, then for each assignment calls `_members.GetByIdAsync(a.MemberId, orgId)` and maps to `ProjectAssignmentDto` (skip if member is null); `AssignAsync` verifies project exists via `_projects.GetByIdAsync(req.ProjectId — actually projectId param, orgId)` (throw `NotFoundException("Project not found")` if null), verifies member exists via `_members.GetByIdAsync(req.MemberId, orgId)` (throw `NotFoundException("Member not found")` if null), checks for duplicate via `_assignments.ListAsync(orgId, a => a.ProjectId == projectId && a.MemberId == req.MemberId)` (throw `ValidationException(new Dictionary<string,string[]>{["memberId"]=["Member is already assigned to this project"]})` if non-empty), then creates new `ProjectAssignment{Id=Guid.NewGuid(), ProjectId=projectId, MemberId=req.MemberId, OrganizationId=orgId}` and calls `AddAsync`; `UnassignAsync` calls `_assignments.ListAsync(orgId, a => a.ProjectId == projectId && a.MemberId == memberId)`, throws `NotFoundException("Assignment not found")` if empty, calls `DeleteAsync` on first result; `GetUtilizationGridAsync` loads all projects for the program year via `_projects.ListAsync(orgId, p => p.ProgramYearId == programYearId)`, loads all active members via `_members.ListAsync(orgId, m => m.IsActive)`, collects all project ids, loads all assignments for those projects via `_assignments.ListAsync(orgId, a => projectIds.Contains(a.ProjectId))`, builds one `UtilizationRowDto` per member (count assignments, collect assigned project ids), sorts rows descending by `AssignedCount`, returns `UtilizationGridDto`; include private `ToDto(ProjectAssignment a, Member m)` helper

- [ ] Register `IProjectAssignmentService` in `src/Stretto.Api/Program.cs` by adding `builder.Services.AddScoped<IProjectAssignmentService, ProjectAssignmentService>();` after the existing `builder.Services.AddScoped<IAttendanceService, AttendanceService>();` line; add `using Stretto.Application.Interfaces;` and `using Stretto.Application.Services;` if not already present

- [ ] Create `src/Stretto.Api/Controllers/ProjectAssignmentsController.cs` with `[ApiController]`, `[Route("api/projects/{projectId:guid}/members")]`; extend `ProtectedControllerBase`; constructor-inject `IProjectAssignmentService` and `IAuthService`; implement three actions: `GET` (no segment) → `GetSessionAsync()` + `ListByProjectAsync(projectId, orgId)` → `Ok(list)`; `POST` (no segment) with `[FromBody] AssignMemberRequest req` → `GetSessionAsync()`, require Admin role (throw `ForbiddenException` otherwise), call `AssignAsync`, return `Created($"/api/projects/{projectId}/members/{dto.MemberId}", dto)`; `DELETE /{memberId:guid}` → `GetSessionAsync()`, require Admin role, call `UnassignAsync(projectId, memberId, orgId)`, return `NoContent()`

- [ ] Create `src/Stretto.Api/Controllers/UtilizationController.cs` with `[ApiController]`, `[Route("api/utilization")]`; extend `ProtectedControllerBase`; constructor-inject `IProjectAssignmentService` and `IAuthService`; implement one action: `GET` with `[FromQuery] Guid? programYearId` → `GetSessionAsync()`, require Admin role (throw `ForbiddenException` otherwise), return `BadRequest(new { message = "programYearId query parameter is required" })` if null, call `GetUtilizationGridAsync(programYearId.Value, orgId)`, return `Ok(dto)`

- [ ] Regenerate the TypeScript client: run `cd src/Stretto.Web && npm run generate` so the new assignment and utilization endpoints appear in `src/Stretto.Web/src/api/generated/`
